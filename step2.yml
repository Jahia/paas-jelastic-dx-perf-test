---
type: update
version: 1.5
name: Jahia - Setup performance test environment
logo: /images/jahia-logo-70x70.png
id: jahia-perf-test

globals:
  defaultCredentials: ${settings.defaultCredentials}
  toolsCredentials: jahia:password

onInstall:
  - cmd [cp,proc]:
      - token=$(curl -u ${globals.toolsCredentials} 'http://localhost:8080/modules/tools/precompileServlet' | grep -Eo 'toolAccessToken=[a-zA-Z0-9\-]+' | head -1 | cut -d '=' -f2)
      - curl -u ${globals.toolsCredentials} 'http://localhost:8080/modules/tools/precompileServlet?compile_type=all&jsp_precompile=true&toolAccessToken=${token}'
      - token=$(curl -u ${globals.toolsCredentials} 'localhost:8080/modules/tools/search.jsp' | grep -Eo 'toolAccessToken=[a-zA-Z0-9\-]+' | head -1 | cut -d '=' -f2)
      - curl -u ${globals.toolsCredentials} 'localhost:8080/modules/tools/search.jsp?action=updateSpellCheckerIndex&toolAccessToken=${token}'
      - sudo service tomcat restart

settings:
  fields:
    - name: defaultCredentials
      type: string
      default: root:root
      caption: Credentials
      vtype: text
      required: false
